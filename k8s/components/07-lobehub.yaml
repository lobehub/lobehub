---
# LobeHub Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lobehub
  namespace: lobehub
  labels:
    app: lobehub
    tier: frontend
    version: latest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lobehub
  template:
    metadata:
      labels:
        app: lobehub
        tier: frontend
        version: latest
    spec:
      initContainers:
      - name: rustfs-init
        image: minio/mc:latest
        env:
        - name: RUSTFS_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: RUSTFS_ACCESS_KEY
        - name: RUSTFS_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: RUSTFS_SECRET_KEY
        command:
        - /bin/sh
        - -c
        - |
          set -eux;
          echo "S3_ACCESS_KEY=${RUSTFS_ACCESS_KEY}, S3_SECRET_KEY=${RUSTFS_SECRET_KEY}";
          mc --version;
          mc alias set rustfs "http://rustfs:9000" "${RUSTFS_ACCESS_KEY}" "${RUSTFS_SECRET_KEY}";
          mc ls rustfs || true;
          mc mb "rustfs/lobe" --ignore-existing;
          mc admin info rustfs || true;
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      containers:
      - name: lobehub
        image: lobehub/lobehub:latest
        ports:
        - containerPort: 3210
          name: http
        env:
        # Core authentication configuration
        - name: AUTH_SECRET
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: AUTH_SECRET
        - name: KEY_VAULTS_SECRET
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: KEY_VAULTS_SECRET

        # Database configuration
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: DATABASE_URL

        # Redis configuration
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: REDIS_URL
        - name: REDIS_PREFIX
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: REDIS_PREFIX
        - name: REDIS_TLS
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: REDIS_TLS

        # S3/Rufs configuration
        - name: S3_BUCKET
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_BUCKET
        - name: S3_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_ENDPOINT
        - name: S3_PUBLIC_DOMAIN
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_PUBLIC_DOMAIN
        - name: S3_ENABLE_PATH_STYLE
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_ENABLE_PATH_STYLE
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_ACCESS_KEY
        - name: S3_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_ACCESS_KEY_ID
        - name: S3_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_SECRET_ACCESS_KEY
        - name: S3_SET_ACL
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: S3_SET_ACL
              
        # Other feature configuration
        - name: LLM_VISION_IMAGE_USE_BASE64
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: LLM_VISION_IMAGE_USE_BASE64
        - name: AUTH_SSO_PROVIDERS
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: AUTH_SSO_PROVIDERS
        - name: SEARXNG_URL
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: SEARXNG_URL
        - name: PORT
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: LOBE_PORT
        - name: APP_URL
          valueFrom:
            secretKeyRef:
              name: lobe-secrets
              key: APP_URL
        command: ["/bin/sh", "-c"]
        args:
        - |
          /bin/node /app/startServer.js
        livenessProbe:
          tcpSocket:
            port: 3210
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
        readinessProbe:
          tcpSocket:
            port: 3210
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

---
# LobeHub Service
apiVersion: v1
kind: Service
metadata:
  name: lobehub
  namespace: lobehub
  labels:
    app: lobehub
    tier: frontend
spec:
  selector:
    app: lobehub
  ports:
  - port: 3210
    targetPort: 3210
    name: http
  type: ClusterIP